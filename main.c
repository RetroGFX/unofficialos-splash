#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <errno.h>
#include <string.h>
#include "fbsplash.h"
#include "svg_parser.h"
#include "svg_renderer.h"
#include "dt_rotation.h"

/*
 * SVG path data for rendering the logo
 * Contains the path data for each component of the logo
 * Index meaning:
 * 0: "U" in logo
 * 1: "N" in logo
 * 2: "O" in logo
 * 2: "F" in logo
 * 3: "F" in logo
 * 4: "I" in logo
 * 5: "C" in logo
 * 6: "I" in logo
 * 7: "A" in logo
 * 8: "L" in logo
 * 9: "O" in logo
 *10: "S" in logo
 */
const char *svg_paths[] = {
    "M 140.46 56.82 L 168.90 56.82 L 168.90 180.90 Q 168.90 213.30 161.58 232.32 Q 154.26 251.34 135.12 263.28 Q 116.04 275.22 84.96 275.22 Q 54.78 275.22 35.58 264.84 Q 16.38 254.46 8.22 234.72 Q 0 214.04 0 180.90 L 0 56.82 L 28.44 56.82 L 28.44 180.78 Q 28.44 208.74 33.60 222.00 Q 38.82 235.26 51.48 242.46 Q 64.14 249.60 82.50 249.60 Q 113.82 249.60 127.14 235.38 Q 140.46 221.22 140.46 180.78 L 140.46 56.82 Z",
    "M 215.94 271.56 L 215.94 56.82 L 245.04 56.82 L 357.84 225.42 L 357.84 56.82 L 385.08 56.82 L 385.08 271.56 L 355.98 271.56 L 243.18 102.84 L 243.18 271.56 L 215.94 271.56 Z",
    "M 424.20 166.98 Q 424.20 113.52 452.94 83.28 Q 481.62 53.04 527.04 53.04 Q 556.80 53.04 580.68 67.26 Q 604.56 81.42 617.04 106.86 Q 629.58 132.30 629.58 164.52 Q 629.58 197.16 616.38 222.96 Q 603.24 248.76 579.06 261.96 Q 554.88 275.22 526.92 275.22 Q 496.56 275.22 472.68 260.58 Q 448.80 245.94 436.50 220.62 Q 424.20 195.24 424.20 166.98 M 453.54 167.46 Q 453.54 206.28 474.36 228.60 Q 495.24 250.92 526.74 250.92 Q 558.84 250.92 579.54 228.36 Q 600.30 205.80 600.30 164.34 Q 600.30 138.12 591.42 118.56 Q 582.54 99.00 565.50 88.26 Q 548.46 77.52 527.22 77.52 Q 497.04 77.52 475.26 98.22 Q 453.54 118.92 453.54 167.46 Z",
    "M 667.68 271.56 L 667.68 56.82 L 812.52 56.82 L 812.52 82.20 L 696.12 82.20 L 696.12 148.68 L 796.86 148.68 L 796.86 174.00 L 696.12 174.00 L 696.12 271.56 L 667.68 271.56 Z",
    "M 850.92 271.56 L 850.92 56.82 L 995.82 56.82 L 995.82 82.20 L 879.36 82.20 L 879.36 148.68 L 980.10 148.68 L 980.10 174.00 L 879.36 174.00 L 879.36 271.56 L 850.92 271.56 Z",
    "M 1037.52 271.56 L 1037.52 56.82 L 1065.96 56.82 L 1065.96 271.56 L 1037.52 271.56 Z",
    "M 1269.30 196.26 L 1297.68 203.46 Q 1288.74 238.50 1265.58 256.86 Q 1242.36 275.22 1208.76 275.22 Q 1174.08 275.22 1152.30 261.12 Q 1130.58 246.96 1119.24 220.14 Q 1107.84 193.38 1107.84 162.60 Q 1107.84 129.06 1120.68 104.10 Q 1133.52 79.08 1157.16 66.12 Q 1180.80 53.16 1209.24 53.16 Q 1241.46 53.16 1263.42 69.60 Q 1285.38 85.98 1294.02 115.74 L 1266.06 122.34 Q 1258.62 98.88 1244.40 88.20 Q 1230.18 77.52 1208.64 77.52 Q 1183.86 77.52 1167.24 89.34 Q 1150.62 101.22 1143.90 121.20 Q 1137.18 141.24 1137.18 162.48 Q 1137.18 189.84 1145.16 210.30 Q 1153.14 230.70 1170.00 240.84 Q 1186.80 250.92 1206.42 250.92 Q 1230.30 250.92 1246.86 237.18 Q 1263.42 223.38 1269.30 196.26 Z",
    "M 1337.52 271.56 L 1337.52 56.82 L 1365.96 56.82 L 1365.96 271.56 L 1337.52 271.56 Z",
    "M 1392.48 271.56 L 1474.98 56.82 L 1505.58 56.82 L 1593.48 271.56 L 1561.08 271.56 L 1536.06 206.52 L 1446.24 206.52 L 1422.66 271.56 L 1392.48 271.56 M 1454.46 183.42 L 1527.24 183.42 L 1504.86 123.90 Q 1494.60 96.84 1489.62 79.38 Q 1485.48 100.02 1478.04 120.42 L 1454.46 183.42 Z",
    "M 1615.02 271.56 L 1615.02 56.82 L 1643.40 56.82 L 1643.40 246.24 L 1749.18 246.24 L 1749.18 271.56 L 1615.02 271.56 Z",
    "M 1774.38 166.98 Q 1774.38 113.52 1803.06 83.28 Q 1831.80 53.04 1877.22 53.04 Q 1906.92 53.04 1930.80 67.26 Q 1954.68 81.42 1967.22 106.86 Q 1979.76 132.30 1979.76 164.52 Q 1979.76 197.16 1966.56 222.96 Q 1953.36 248.76 1929.18 261.96 Q 1905.00 275.22 1877.04 275.22 Q 1846.74 275.22 1822.86 260.58 Q 1798.98 245.94 1786.68 220.62 Q 1774.38 195.24 1774.38 166.98 M 1803.66 167.46 Q 1803.66 206.28 1824.54 228.60 Q 1845.42 250.92 1876.92 250.92 Q 1908.96 250.92 1929.72 228.36 Q 1950.42 205.80 1950.42 164.34 Q 1950.42 138.12 1941.60 118.56 Q 1932.72 99.00 1915.62 88.26 Q 1898.58 77.52 1877.34 77.52 Q 1847.16 77.52 1825.44 98.22 Q 1803.66 118.92 1803.66 167.46 Z",
    "M 2006.70 202.56 L 2033.52 200.22 Q 2035.38 216.36 2042.34 226.68 Q 2049.30 237.00 2063.94 243.36 Q 2078.64 249.78 2096.94 249.78 Q 2113.20 249.78 2125.62 244.92 Q 2138.10 240.06 2144.16 231.66 Q 2150.22 223.26 2150.22 213.30 Q 2150.22 203.16 2144.40 195.60 Q 2138.52 188.10 2125.02 182.94 Q 2116.38 179.58 2086.80 172.50 Q 2057.22 165.36 2045.34 159.06 Q 2029.98 151.02 2022.42 139.08 Q 2014.92 127.14 2014.92 112.38 Q 2014.92 96.12 2024.10 81.96 Q 2033.34 67.80 2051.10 60.48 Q 2068.80 53.16 2090.46 53.16 Q 2114.34 53.16 2132.58 60.84 Q 2150.82 68.58 2160.66 83.52 Q 2170.44 98.46 2171.22 117.36 L 2143.92 119.40 Q 2141.76 99.00 2129.10 88.62 Q 2116.38 78.24 2091.66 78.24 Q 2065.86 78.24 2054.10 87.66 Q 2042.28 97.14 2042.28 110.46 Q 2042.28 122.04 2050.62 129.48 Q 2058.84 136.98 2093.46 144.78 Q 2128.14 152.64 2141.04 158.52 Q 2159.76 167.16 2168.70 180.42 Q 2177.64 193.68 2177.64 210.96 Q 2177.64 228.06 2167.80 243.24 Q 2158.02 258.42 2139.60 266.82 Q 2121.24 275.22 2098.26 275.22 Q 2069.10 275.22 2049.36 266.76 Q 2029.68 258.24 2018.46 241.20 Q 2007.30 224.10 2006.70 202.56 Z"
};

/* Color definitions for each path component
 * First 4 paths are red (brand color)
 * Last 3 paths are gray (secondary color)
 */
const char *svg_colors[] = {
    "rgb(40,40,180)",  // Blue
    "rgb(40,40,180)",  // Blue
    "rgb(40,40,180)",  // Blue
    "rgb(40,40,180)",  // Blue
    "rgb(40,40,180)",  // Blue
    "rgb(40,40,180)",  // Blue
    "rgb(40,40,180)",  // Blue
    "rgb(40,40,180)",  // Blue
    "rgb(40,40,180)",  // Blue
    "rgb(40,40,180)",  // Blue
    "rgb(85,85,85)",   // Gray
    "rgb(85,85,85)",   // Gray
};

#define NUM_PATHS (sizeof(svg_paths) / sizeof(svg_paths[0]))

/*
 * Main program entry point
 */
int main(void) {
    const char *fb_device = "/dev/fb0";

    // Get rotation from device tree
    int rotation = get_display_rotation();

    // Check framebuffer device accessibility
    if (access(fb_device, R_OK | W_OK) != 0) {
        fprintf(stderr, "Cannot access %s: %s\n", fb_device, strerror(errno));
        return 1;
    }

    // Initialize framebuffer
    Framebuffer *fb = fb_init(fb_device);
    if (!fb) {
        fprintf(stderr, "Failed to initialize framebuffer\n");
        return 1;
    }

    // Calculate display parameters
    DisplayInfo *display_info = calculate_display_info(fb);
    if (!display_info) {
        fprintf(stderr, "Failed to calculate display information\n");
        fb_cleanup(fb);
        return 1;
    }

    // Clear screen to black
    for (uint32_t y = 0; y < fb->vinfo.yres; y++) {
        for (uint32_t x = 0; x < fb->vinfo.xres; x++) {
            set_pixel(fb, x, y, 0x00000000);
        }
    }

    // Process and render each path component
    for (size_t i = 0; i < NUM_PATHS; i++) {
        SVGPath *svg = parse_svg_path(svg_paths[i], svg_colors[i]);
        if (!svg) {
            fprintf(stderr, "Failed to parse SVG path %zu\n", i);
            continue;
        }

        // Apply rotation from device tree if specified
        if (rotation)
            rotate_svg_path(svg, rotation);

        // Render the path
        render_svg_path(fb, svg, display_info);
        free_svg_path(svg);
    }

    // Flush changes to the framebuffer
    fb_flush(fb);

    // Clean up
    free(display_info);
    fb_cleanup(fb);

    return 0;
}
